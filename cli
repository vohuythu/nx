#!/bin/bash

# Đảm bảo chạy từ thư mục home
cd ~

# Cập nhật hệ thống
sudo apt-get update && sudo apt-get upgrade -y

# Thiết lập swap 100GB (nếu chưa có)
if [ ! -f /swapfile ]; then
    sudo fallocate -l 100G /swapfile
    sudo chmod 600 /swapfile
    sudo mkswap /swapfile
    sudo swapon /swapfile
    echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
fi

# Cấu hình hệ thống tối ưu RAM
echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
echo 'vm.overcommit_memory=1' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

# Cài đặt Docker
sudo apt-get install -y docker.io
sudo systemctl enable --now docker
sudo usermod -aG docker $USER

# Chạy container Docker
docker run --cpus=$(nproc) my_proving_container &

# Cài đặt Homebrew (Dành cho Linux)
NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

# Cài đặt Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
export PATH="$HOME/.cargo/bin:$PATH"

# Cài đặt CMake qua Homebrew
brew install cmake

# Cài đặt Nexus CLI
curl -fsSL https://cli.nexus.xyz/ | sh

# Kiểm tra Nexus CLI có tồn tại không
if [ ! -f "$HOME/.nexus/network-api/clients/cli/target/release/nexus-network" ]; then
    echo "Lỗi: Nexus CLI không được cài đặt thành công."
    exit 1
fi

# Tạo service tự động chạy node
cat <<EOF | sudo tee /etc/systemd/system/nexus-node.service
[Unit]
Description=Nexus Node Auto Start
After=network.target

[Service]
User=$USER
WorkingDirectory=$HOME
ExecStart=$HOME/.nexus/network-api/clients/cli/target/release/nexus-network start
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Kích hoạt service
sudo systemctl daemon-reload
sudo systemctl enable nexus-node.service
sudo systemctl start nexus-node.service

echo "Cài đặt hoàn tất!"
