#!/bin/bash

set -e  # Dừng script nếu có lỗi

# Cập nhật hệ thống
echo "Cập nhật hệ thống..."
sudo apt update && sudo apt upgrade -y

# Cài đặt các gói cần thiết
echo "Cài đặt build-essential, pkg-config, libssl-dev, git..."
sudo apt install -y build-essential pkg-config libssl-dev git-all curl

# Cài đặt Homebrew
echo "Cài đặt Homebrew..."
NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Cập nhật PATH cho Homebrew
echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.bashrc
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

# Cài đặt CMake
echo "Cài đặt CMake..."
brew install cmake -y

# Cài đặt Rust
echo "Cài đặt Rust..."
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
source "$HOME/.cargo/env"

# Thêm target Rust cho riscv32i-unknown-none-elf
echo "Thêm target Rust..."
rustup target add riscv32i-unknown-none-elf

# Cài đặt Nexus CLI
echo "Cài đặt Nexus CLI..."
curl -fsSL https://cli.nexus.xyz/ | sh

# Tạo file script để chạy node
NODE_START_SCRIPT="$HOME/start_node.sh"
echo "Tạo script khởi động node tại $NODE_START_SCRIPT"

cat <<EOF > $NODE_START_SCRIPT
#!/bin/bash
source "\$HOME/.cargo/env"
export PATH="\$HOME/.nexus/network-api/clients/cli/target/release:\$PATH"
nexus-network start
EOF

chmod +x $NODE_START_SCRIPT

# Tạo systemd service để tự động chạy node khi khởi động
echo "Tạo systemd service để chạy node sau khi reboot..."
SERVICE_FILE="/etc/systemd/system/nexus-node.service"
sudo tee $SERVICE_FILE > /dev/null <<EOF
[Unit]
Description=Nexus Node Auto Start
After=network.target

[Service]
User=$USER
ExecStart=$NODE_START_SCRIPT
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Kích hoạt service tự động chạy khi khởi động
sudo systemctl daemon-reload
sudo systemctl enable nexus-node.service
sudo systemctl start nexus-node.service

echo "Cài đặt hoàn tất! Node sẽ tự động chạy sau mỗi lần reboot."
