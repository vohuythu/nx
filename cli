#!/bin/bash

# Cập nhật hệ thống
sudo apt update && sudo apt upgrade -y

# Cài đặt các gói cần thiết
sudo apt install -y build-essential pkg-config libssl-dev git-all

sudo apt remove -y protobuf-compiler
sudo apt install -y autoconf automake libtool curl make g++ unzip

# Clone repo Protobuf
git clone --depth=1 --branch=v21.12 https://github.com/protocolbuffers/protobuf.git
cd protobuf

# Biên dịch và cài đặt Protobuf
git submodule update --init --recursive
./autogen.sh
./configure
make -j$(nproc)
sudo make install
sudo ldconfig

# Kiểm tra lại phiên bản
protoc --version

# Cài đặt Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Cài đặt Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
export PATH="$HOME/.cargo/bin:$PATH"

# Cài đặt CMake qua Homebrew
brew install cmake

# Thêm target cho Rust
rustup target add riscv32i-unknown-none-elf

# Cài đặt Nexus CLI
curl https://cli.nexus.xyz/ | sh

# Tạo script tự động chạy node khi khởi động
cat <<EOF | sudo tee /etc/systemd/system/nexus-node.service
[Unit]
Description=Nexus Node Auto Start
After=network.target

[Service]
User=$USER
ExecStart=$HOME/.nexus/network-api/clients/cli/target/release/nexus-network start
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Kích hoạt service tự động chạy node khi khởi động
sudo systemctl daemon-reload
sudo systemctl enable nexus-node.service
sudo systemctl start nexus-node.service

# Thông báo hoàn thành
echo "Cài đặt hoàn tất!"
